
var json=[{
    "uid":"22412",
    "name": "op1",
    "taskList": [{
        "Subject": "任务1",
        "StartDate": "2016-10-02",
        "DueDate": "2016-10-05",
        "AuthorName": 'wmm',
        "DoneRatio": '60%'
    }, {
        "Subject": "任务22",
        "StartDate": "2016-11-15",
        "DueDate": "2016-11-30",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-11-29",
        "DueDate": "2016-12-10",
        "AuthorName": 'wmm',
        "DoneRatio": '60%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-25",
        "DueDate": "2016-11-30",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    },{
        "Subject": "任务任务任务任务任务1",
        "StartDate": "2016-11-29",
        "DueDate": "2016-12-01",
        "AuthorName": 'wmm',
        "DoneRatio": '60%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-02",
        "DueDate": "2016-11-07",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    }]
}, {
    "uid":"10902",
    "name": "op2",
    "taskList": [{
        "Subject": "任务3",
        "StartDate": "2016-10-03",
        "DueDate": "2016-11-10",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }, {
        "Subject": "任务4",
        "StartDate": "2016-10-20",
        "DueDate": "2016-10-27",
        "AuthorName": 'wmm',
        "DoneRatio": '0%'
    },{
        "Subject": "任务3",
        "StartDate": "2016-10-30",
        "DueDate": "2016-11-04",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }, {
        "Subject": "任务4",
        "StartDate": "2016-11-02",
        "DueDate": "2016-11-13",
        "AuthorName": 'wmm',
        "DoneRatio": '80%'
    },{
        "Subject": "任务3",
        "StartDate": "2016-11-09",
        "DueDate": "2016-11-16",
        "AuthorName": 'wmm',
        "DoneRatio": '70%'
    }, {
        "Subject": "任务4",
        "StartDate": "2016-12-03",
        "DueDate": "2016-12-09",
        "AuthorName": 'wmm',
        "DoneRatio": '0%'
    },{
        "Subject": "任务3",
        "StartDate": "2016-12-04",
        "DueDate": "2016-12-15",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }, {
        "Subject": "任务4",
        "StartDate": "2016-11-16",
        "DueDate": "2016-11-21",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }]
},{
    "uid":"21732",
    "name": "op3",
    "taskList": []
},{
    "uid":"35464",
    "name": "op4",
    "taskList": [{
        "Subject": "任务1",
        "StartDate": "2016-10-03",
        "DueDate": "2016-12-17",
        "AuthorName": 'wmm',
        "DoneRatio": '50%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-15",
        "DueDate": "2016-11-20",
        "AuthorName": 'wmm',
        "DoneRatio": '50%'
    },{
        "Subject": "任务3",
        "StartDate": "2016-11-29",
        "DueDate": "2016-12-03",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }]
},{
    "uid":"34202",
    "name": "op5",
    "taskList": [{
        "Subject": "任务1",
        "StartDate": "2016-11-29",
        "DueDate": "2016-12-10",
        "AuthorName": 'wmm',
        "DoneRatio": '60%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-15",
        "DueDate": "2016-11-30",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-12-03",
        "DueDate": "2016-12-13",
        "AuthorName": 'wmm',
        "DoneRatio": '60%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-25",
        "DueDate": "2016-11-30",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    }]
},{
    "uid":"10459",
    "name": "op6",
    "taskList": [{
        "Subject": "任务1",
        "StartDate": "2016-11-27",
        "DueDate": "2016-12-17",
        "AuthorName": 'wmm',
        "DoneRatio": '90%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-10-19",
        "DueDate": "2016-10-28",
        "AuthorName": 'wmm',
        "DoneRatio": '90%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-10-29",
        "DueDate": "2016-11-07",
        "AuthorName": 'wmm',
        "DoneRatio": '90%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-03",
        "DueDate": "2016-11-08",
        "AuthorName": 'wmm',
        "DoneRatio": '40%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-11-13",
        "DueDate": "2016-11-24",
        "AuthorName": 'wmm',
        "DoneRatio": '30%'
    }, {
        "Subject": "任务2",
        "StartDate": "2016-11-22",
        "DueDate": "2016-12-04",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }]
},{
    "uid":"10903",
    "name": "op7",
    "taskList": [{
        "Subject": "任务1",
        "StartDate": "2016-11-27",
        "DueDate": "2016-12-17",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    },{
        "Subject": "任务1",
        "StartDate": "2016-10-19",
        "DueDate": "2016-10-28",
        "AuthorName": 'wmm',
        "DoneRatio": '10%'
    }]
}];
var calendar,vdate=[];
var position=null,
oriEvent=null,
scrollTop=0;
validEvents=[{
            id: '1',
            uniqueId: '2018-02-14-1',
            title: 'Meeting',
            start: '2018-02-14',
            hour: 120,
            usehour: 0,
            percent: 0,
        },
        {
            id: '2',
            uniqueId: '2018-02-15-2',
            title: 'Meeting25',
            start: '2018-02-15',
            hour: 140,
            usehour: 14,
            percent: 10,
        },{
            id: '3',
            uniqueId: '2018-02-15-3',
            title: 'Meeting2',
            start: '2018-02-15',
            hour: 170,
            usehour: 34,
            percent: 20
        }];
$(function(){
	bindEvent();
	$('#external-events .fc-event').each(function() {

      // store data so the calendar knows to render an event upon drop
      $(this).data('event', {
        title: $.trim($(this).text()), // use the element's text as the event title
        // stick: true, // maintain when user navigates (see docs on the renderEvent method)
        hour: 40,
        drop: true,
        norender: true
      });

      // 使用jQuery UI draggable
      $(this).draggable({
        zIndex: 999,
        revert: true,
        revertDuration: 0,
        start: function(event,ui){

        },
        stop: function(event,ui){
        	// console.log(event);
        	// console.log(ui);
        }
      });

    });


	calendar=$('#calendar').fullCalendar({
		buttonHtml: {
			prev: '<i class="ace-icon fa fa-chevron-left"></i>',
			next: '<i class="ace-icon fa fa-chevron-right"></i>'
		},
		// visibleRange: {
		// 	start: '2018-02-04',
		// 	end: '2018-02-20'
		// },
		// validRange: {
		// 	start: getCurrentDate(),
		// },
		fixedWeekCount : false,
		locale: 'zh-cn',
		header: {
			left: 'prev,next today',
			center: 'title',
			right: 'month,basicWeek'
		},
		events: validEvents,
		handleWindowResize: true,
		editable: false,
		droppable: true,
		drop: function(date) { // this function is called when something is dropped
		
			// // retrieve the dropped element's stored Event Object
			var oriobj = $(this).data('event');
			oriobj.start=date;
			oriobj.allDay=false;
			console.log(999999999);
			scrollTop=$('.fc-day-grid-container')[0].scrollTop;
			if(new Date(date).getTime()>new Date(getCurrentDate()).getTime()){
				$(this).remove();
			}
			if($('#external-events .fc-event').length){
				$('#external-events .nodata').show();
			}
			// var $extraEventClass = $(this).attr('data-class');
			
			
			// // we need to copy it, so that multiple events don't have a reference to the same object
			// var copiedEventObject = $.extend({}, originalEventObject);
			
			// // assign it the date that was reported
			// copiedEventObject.start = date;
			// copiedEventObject.allDay = false;
			// if($extraEventClass) copiedEventObject['className'] = [$extraEventClass];
			
			// // render the event on the calendar
			// // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
			// $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
			
			// // is the "remove after drop" checkbox checked?
			// if ($('#drop-remove').is(':checked')) {
			// 	// if so, remove the element from the "Draggable Events" list
			// 	$(this).remove();
			// }
			
		},
		selectable: true,
		selectHelper: true,
		select: function(start, end, allDay) {

		},
		eventAllow: function(dropInfo, draggedEvent){
			console.log(888888888888)
		},
		eventClick: function(calEvent, jsEvent, view) {
			// console.log(77777);
			eventModal();
		},
		eventRender: function(calEvent, element, view){
			// console.log(calEvent);
			// console.log(element);
			// console.log(view);
			// console.log(999999);
			// console.log(calEvent);
			if(calEvent.drop==true){
				setTimeout(function(){
					var timeFlag=new Date(calEvent.start).getTime()>new Date(getCurrentDate()).getTime()?true:false;
					if(oriEvent!=null&&timeFlag){
						// console.log(77777777);
						var uniqueId=oriEvent.uniqueId;
						validEvents.forEach(function(item){
							if(item.uniqueId==uniqueId){
								item.usehour+=calEvent.hour;
								item.percent=(item.usehour*100/oriEvent.hour).toFixed(4);
								return false;
							}
						});
						$('#calendar').fullCalendar( 'removeEvents');
        				$('#calendar').fullCalendar('renderEvents', validEvents);
						// $('#calendar').fullCalendar('updateEvents', validEvents);
						// $('#calendar').fullCalendar('updateEvent', oriEvent);
						// console.log(oriEvent.percent);
						oriEvent=null;
					}
				},0);
				return false;
			}else{
				var progressColor='',
				tip='';
				if(calEvent.percent>120){
					progressColor='danger';
					tip='<p class="dangertip">已超出最大生产能力</p>';
				}else if(calEvent.percent>100){
					progressColor='palert';
				}else if(calEvent.percent>0){
					progressColor='ori';
				}else{
					progressColor='gray'
				}
				// var progressColor=calEvent.percent>120?'danger':calEvent.percent>100?'palert':'ori';
				var test=`
				<div class="op-fc-wrap" data-hour="${calEvent.hour}" data-name="111">
				<span>${calEvent.title}</span>
				<div class="progress pos-rel ${progressColor}" data-percent="${calEvent.percent}%">
					<div class="progress-bar" style="width:${calEvent.percent}%;"></div>
				</div>
				${tip}
				</div>`;
				$(element).find('.fc-content').html(test);
			}
		},
		eventAfterAllRender: function(view){
			setTimeout(function(){
				console.log(scrollTop);
				$('.fc-day-grid-container')[0].scrollTop=scrollTop;
			},0);
		},
		eventDragStart: function(event, jsEvent, ui, view){
			console.log(event);
		},
		eventDragStop: function(event, jsEvent, ui, view){
			console.log(event);
		},
		eventDrop: function(event, delta, revertFunc, jsEvent, ui, view){
			console.log(event);
			console.log(delta);
			console.log(revertFunc);
			console.log(jsEvent);
			console.log(view);
		},
		eventMouseover: function(event, jsEvent, view){
			// console.log(event);
			oriEvent=$.extend({}, event);
			// console.log(jsEvent);
			position=$(jsEvent.currentTarget);
		},
		eventMouseout: function(event, jsEvent, view){
			oriEvent=null;
			position=null;
		}
	});
	$('.fc-day.fc-widget-content').each(function(){
		var date=$(this).attr('data-date');
		if(date!=undefined){
			vdate.push($(this).attr('data-date'));
		}
	});
	// console.log(vdate);
});

var ops=[{id: 1, operation_id: 1, name: "开始"},
{id: 2, operation_id: 2, name: "工序001"},
{id: 3, operation_id: 3, name: "工序002"},
{id: 4, operation_id: 4, name: "工序003"},
{id: 5, operation_id: 5, name: "工序004"},
{id: 6, operation_id: 6, name: "工序005"},
{id: 7, operation_id: 7, name: "工序006"},
{id: 8, operation_id: 8, name: "工序007"},
{id: 9, operation_id: 9, name: "工序008"},
{id: 10, operation_id: 10, name: "工序0010"}];

function getCurrentDate(){
	var date = new Date();
	var d = date.getDate();
	var m = date.getMonth()+1;
	var y = date.getFullYear();
	d<10?d='0'+d:null;
	m<10?m='0'+m:null;

	return y+'-'+m+'-'+d;
}

// 生成工序面板
function createOp(data){
	var lis='';
    data.forEach(function(item){
        lis+=`<input type="checkbox" class="op-input" id="${item.id}" name="${item.name}" value="${item.id}">
            <label class="op-label" title="${item.name}" for="${item.id}">${item.name}</label>`;
    });
    $('.all-ops .ops').html(lis);
    // return lis;
}

createOp(ops);

function createDateOp(ops){
	var events=[];
	vdate.forEach(function(item){
		ops.forEach(function(pitem){
			var obj={
				id: pitem.id,
	            uniqueId: item+'-'+pitem.id,
	            title: pitem.name,
				start: item,
	            hour: 170,
	            usehour: 0,
	            percent: 0
			};
			events.push(obj);
		});
	});
	return events;
}

function eventModal(){
    var height=($(window).height()-200)+'px';
    var labelWidth=100,
        title='编辑工序A下的工单';
    layerModal=layer.open({
      type: 1, 
      title: title,
      offset: '100px',
      area: '500px',
      shade: 0.1,
      shadeClose: false,
      resize: false,
      move: false,
      content: `<form class="editWO formModal formMateriel" id="editWO">
            <div class="modal-wrap">
            <div class="table_page">
                <div class="table-wrap" style="max-height: ${height};overflow-y: auto;">
                    <table class="sticky uniquetable commontable">
                      <thead>
                        <tr>
                          <th>工序A(120标准工时)</th>
                          <th>占比(%)</th>
                          <th>累计占比(%)</th>
                          <th class="right">操作</th>
                        </tr>
                      </thead>
                      <tbody class="table_tbody">
                      	<tr><td>wo001</td><td>5</td><td>5</td><td class="right"><button class="el-button btn-wo-del">删除</button></td></tr>
                      	<tr><td>wo002</td><td>5</td><td>10</td><td class="right"><button class="el-button btn-wo-del">删除</button></td></tr>
                      </tbody>
                    </table>
                </div>
          	</div>
          </div>
        </form>` ,
    success: function(layero,index){
    	
    },
    end: function(){
    }
	}); 
}

function orderModal(){
	var height=($(window).height()-200)+'px';
    layerModal=layer.open({
      type: 1, 
      title: '查看订单生产排程',
      offset: '100px',
      area: ['1040px'],
      shade: 0.1,
      shadeClose: false,
      resize: false,
      move: false,
      content: `<div class="gantt-all-wrap">
      <div class="tophead clearfix">
		<div class="el-form-item">
            <div class="el-form-item-div">
                <label class="el-form-item-label">时间筛选</label>
                <span class="el-input span start_time"><span id="start_time_input"></span><input type="text" id="start_time" placeholder="开始时间" value=""></span>——
                <span class="el-input span end_time"><span id="end_time_input"></span><input type="text" id="end_time" placeholder="结束时间" value=""></span>
            </div>
        </div>
      </div>
      <div class="gantt-div-wrap">
      	<div class="GanttWrap"></div>
      	</div>
      </div>` ,
    success: function(layero,index){
    	var ganttChart = function() {
		    $(".GanttWrap").GanttTool({
		        'startDate': '2016-10-01',
		        'endDate': '2016-12-02',
		        'ajaxUrl': null,
		        'arrdata': json,
		        'layer': layero,
		        'parameters': {}, //其他参数
		        'fn': null //回调方法
		    });
		};
		ganttChart();
    },
    end: function(){
    }
	}); 
}

function fullscreen(){
	var fsElement = document.getElementById('wrap');
	if (fsElement.requestFullscreen) { //w3c
		fsElement.requestFullscreen(); 
	}else if (fsElement.webkitRequestFullScreen) { //chrome
		fsElement.webkitRequestFullScreen(); 
	}else if (fsElement.mozRequestFullScreen) { //firefox
	  	fsElement.mozRequestFullScreen(); 
	}else if (fsElement.msRequestFullscreen) { //ie
 		fsElement.msRequestFullscreen();
	}
}

function bindEvent(){
	//工序面板
	$('.btn-choose-op').on('click',function(){
		if($('.all-ops').is(":hidden")){
			$('.all-ops').slideDown(300);
		}else{
			$('.all-ops').slideUp(300);
		}
		
	});
	//选择工序
	$('.btn-ok').on('click',function(){
		var ops=[];
        $('#el-checkbox-wrap').find('.op-input:checked').each(function(item){
        	var obj={
        		id: $(this).val(),
        		name: $(this).attr('name')
        	};
            ops.push(obj);
        });
        $('.all-ops').slideUp(300);
        var view=calendar.fullCalendar( 'getView' );
        // console.log(view);
        // console.log($('#calendar').fullCalendar('getCalendar'));
        // console.log(calendar.fullCalendar( 'clientEvents' ))
        if(view.type=='month'){

        }
        // console.log(createDateOp(ops));
        calendar.fullCalendar( 'removeEvents');
        validEvents=createDateOp(ops);
        calendar.fullCalendar('renderEvents', validEvents);

        // console.log($('#calendar').fullCalendar('getCalendar'));
	});

	//删除工序下的工单
	$('body').on('click','btn-wo-del',function(){
		$(this).parents('tr').remove();
		//将该工单变为可选工单，并发送异步
	});
	//查看生产进度
	$('.btn-look-order').on('click',function(){
		orderModal();
	});
	//全屏展示
	$('.btn-full-screen').on('click',function(){
		fullscreen();
	});
	$(document).on('keydown',function(event){
		if (event.keyCode == 13 && event.ctrlKey) {
            event.preventDefault();
            fullscreen();
        }
	});
}